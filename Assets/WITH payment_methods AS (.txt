WITH payment_methods AS (
	SELECT 
		id AS order_id,
		STRING_AGG(payments.value->>'paymentSystemName', '|') AS names
	FROM 
		client_vtexorder,
		jsonb_array_elements(data->'paymentData'->'transactions'->0->'payments') AS payments
	WHERE 
		created_at::date >= '2020-12-24' AND
		created_at::date <= '2021-01-05'
	GROUP BY 
		id
)
SELECT 
	sp.fantasy_name AS "Shopping Origem",
	TO_CHAR(cv.created_at, 'DD/MM/YYYY') AS "Data Pedido",
	cv.foreign_id AS "Nr Pedido",
	CASE 
		WHEN cv.status = 'payment-pending' THEN 'Pagamento Pendente'
		WHEN cv.status = 'payment-approved' THEN 'Pagamento Aprovado'
		WHEN cv.status = 'invoiced' THEN 'Faturado'
		WHEN cv.status = 'handling' THEN 'Handling'
		WHEN cv.status = 'window-to-cancel' THEN 'Cancelando'
		WHEN cv.status = 'canceled' THEN 'Cancelado'
		WHEN cv.status = 'start-handling' THEN 'Start Handling'
		WHEN cv.status = 'waiting-ffmt-authorization' THEN 'Aguardando Pagamento'
    WHEN cv.status = 'on-order-completed-ffm' THEN 'Processando'
	  ELSE 'Status não mapeado'
	END AS "Status",
	cc.name AS "Cliente",
	cc.document AS "Documento",
	ce.account_name AS "Cod. Loja",
	cs.fancy_name AS "Loja",
	csk.reference_code AS "Cód. Produto",
	csk.name AS "Produto",
	co.price AS "Valor Produto",
	co.quantity AS "Quantidade",
	cv.total_amount AS "Valor Pedido",
	cv.total_discounts AS "Desconto",
	cv.selected_sla AS "Modal de Entrega",
	cv.discount_tags AS "Desconto Desc.",
	ct.pagarme_id AS "TID",
	ct.status AS "Pagarme Status",
	pm.names AS "Meios de Pagamento",
	co.commission AS "Comissão"
FROM 
	client_vtexorder cv
LEFT JOIN
	client_transaction ct ON ct.id = cv.transaction_id
LEFT JOIN
	client_environment ce ON ce.id = cv.environment_id
LEFT JOIN
	client_shopping sp ON sp.id = cv.shopping_id
LEFT JOIN 
	client_client cc ON cc.id = cv.client_id
LEFT JOIN
	client_seller cs ON cs.environment_id = ce.id
LEFT JOIN
	client_orderitem co ON co.vtex_order_id = cv.id
LEFT JOIN
	client_sku csk ON csk.id = co.product_sku_id
LEFT JOIN 
	payment_methods pm ON pm.order_id = cv.id
WHERE
	ce.marketplace_id = 7 AND
	cv.created_at::date >= '2020-12-24' AND
	cv.created_at::date <= '2021-01-05'
ORDER BY 
	cv.created_at ASC;